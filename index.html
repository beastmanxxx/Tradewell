<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trading App</title>
  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- React and ReactDOM via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- TradingView Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Add manifest.json link -->
  <link rel="manifest" href="manifest.json">
  <style>
    html, body, #root {
      width: 100vw;
      min-height: 100vh;
      height: 100vh;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      overflow-x: hidden;
      background: #10131a;
    }
    body {
      font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
      background: #10131a;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    #root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      max-width: 480px;
      width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      background: #181c23;
      border-radius: 22px;
      box-shadow: 0 6px 32px #0006;
      padding: 0 0 0 0;
      position: relative;
      box-sizing: border-box;
      margin: 0 auto;
      gap: 18px;
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 28px 24px 16px 24px;
      margin-top: 160px;
      min-height: 64px;
      background: transparent;
      width: 95%;
      margin-left: auto;
      margin-right: auto;
    }
    .profile-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .profile-avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 2px solid #FFD600;
      background: #23272f;
      object-fit: cover;
      box-shadow: 0 2px 8px #0004;
    }
    .profile-username {
      font-size: 1.62rem;
      font-weight: 700;
      color: #FFD600;
      letter-spacing: 0.5px;
    }
    .profile-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logout-btn {
      background: #23272f;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 7px 18px;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      transition: filter 0.2s;
    }
    .logout-btn:hover {
      filter: brightness(1.1);
    }
    .balance-card {
      background: #15181f;
      border-radius: 16px;
      padding: 28px 18px 22px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0 18px 0 18px;
      box-shadow: 0 2px 12px #0003;
      box-sizing: border-box;
      margin-bottom: 10px;
      padding-bottom: 10px;
      flex-shrink: 0;
    }
    .balance-amount {
      font-size: 2.1rem;
      font-weight: 700;
      color: #FFD600;
      text-shadow: 0 1px 4px #0008;
      text-align: center;
      margin-bottom: 4px;
    }
    .balance-label {
      font-size: 1.08rem;
      color: #fff;
      font-weight: 500;
      letter-spacing: 0.5px;
      opacity: 0.7;
      text-align: center;
      margin-bottom: 18px;
    }
    .balance-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      width: 100%;
    }
    .balance-actions button {
      margin-left: 0;
      background: #43a047;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 28px;
      font-size: 1.08rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px #0002;
    }
    .balance-actions button:last-child {
      background: #e53935;
    }
    .balance-actions button:hover {
      filter: brightness(1.1);
      box-shadow: 0 4px 16px #0004;
    }
    .chart-section {
      margin: 0;
      background: #10131a;
      border-radius: 32px;
      padding: 0;
      box-shadow: 0 2px 12px #0003;
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 0 !important;
      box-sizing: border-box;
      border-bottom: 2px solid #23272f;
      overflow: hidden;
      min-height: unset;
      align-items: center;
    }
    #chart {
      width: 98%;
      min-width: 320px;
      max-width: 440px;
      height: 320px;
      min-height: 220px;
      background: #181c23;
      border-radius: 28px;
      box-sizing: border-box;
      overflow: hidden;
      margin-bottom: 0 !important;
      padding-bottom: 0 !important;
    }
    .amount-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
      margin-top: 10px;
      justify-content: center;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      flex-shrink: 0;
    }
    .amount-btn {
      background: #181c23;
      color: #FFD600;
      border: 2px solid #FFD600;
      border-radius: 8px;
      padding: 8px 20px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px #0002;
      min-width: 80px;
      min-height: 38px;
      flex-shrink: 0;
    }
    .amount-btn.selected, .amount-btn:hover {
      background: #FFD600;
      color: #181c23;
      box-shadow: 0 4px 16px #FFD60044;
    }
    .custom-amount-input {
      width: 90px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 2px solid #FFD600;
      background: #181c23;
      color: #FFD600;
      font-size: 1.05rem;
      font-family: 'Poppins', Arial, sans-serif;
      outline: none;
      font-weight: 600;
      min-width: 80px;
      min-height: 38px;
      flex-shrink: 0;
    }
    .bet-section {
      display: flex;
      justify-content: center;
      gap: 22px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      flex-shrink: 0;
    }
    .bet-btn {
      background: #43a047;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 14px 32px;
      font-size: 1.15rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 12px #0003;
      min-width: 80px;
      min-height: 38px;
      flex-shrink: 0;
    }
    .bet-btn.down {
      background: #e53935;
    }
    .bet-btn:active {
      filter: brightness(0.95);
    }
    .bet-btn.down:active {
      filter: brightness(0.85);
    }
    .bet-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .bet-status {
      text-align: center;
      margin-top: 22px;
      font-size: 1.15rem;
      font-weight: 600;
      color: #FFD600;
      text-shadow: 0 1px 4px #0008;
    }
    .bet-info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFD600;
      color: #181c23;
      font-weight: 700;
      font-size: 1.08rem;
      padding: 10px 18px;
      border-radius: 12px 12px 0 0;
      margin-bottom: 0;
      margin-top: -22px;
      box-shadow: 0 2px 12px #FFD60044;
    }
    .bet-timer {
      font-size: 1.15rem;
      font-family: monospace;
      margin-left: 22px;
      background: #181c23;
      color: #FFD600;
      padding: 3px 14px;
      border-radius: 8px;
      min-width: 44px;
      text-align: right;
      font-weight: 700;
      box-shadow: 0 2px 8px #0002;
    }
    .chart-card {
      background: #181c23;
      border-radius: 18px;
      box-shadow: 0 2px 12px #0006;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 480px;
      box-sizing: border-box;
      min-height: unset;
      margin-bottom: 0 !important;
      padding-bottom: 0 !important;
      flex-shrink: 0;
    }
    .trade-panel-card {
      background: #181c23;
      border-radius: 18px;
      box-shadow: 0 2px 12px #0006;
      padding: 18px 12px 18px 12px;
      margin: 0 0 38px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 480px;
      box-sizing: border-box;
      margin-bottom: 18px;
      padding-bottom: 10px;
      flex-shrink: 0;
    }
    .open-trade-bar {
      background: #23272f;
      border-radius: 12px;
      padding: 10px 16px;
      margin-bottom: 18px;
      width: 100%;
      text-align: center;
      font-size: 1.08rem;
      font-weight: 600;
      color: #FFD600;
      box-shadow: 0 2px 8px #0002;
    }
    .trade-timer {
      font-size: 1.15rem;
      font-family: monospace;
      margin-left: 22px;
      background: #181c23;
      color: #FFD600;
      padding: 3px 14px;
      border-radius: 8px;
      min-width: 44px;
      text-align: right;
      font-weight: 700;
      box-shadow: 0 2px 8px #0002;
    }
    .notification-bar {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      background: #FFD600;
      color: #181c23;
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 16px #FFD60044;
      z-index: 1000;
      font-weight: 700;
      font-size: 1.15rem;
      text-align: center;
      margin-top: 10px;
      transition: background 0.2s, color 0.2s;
    }
    .notification-bar.win {
      background: #43a047;
      color: #fff;
    }
    .notification-bar.loss {
      background: #e53935;
      color: #fff;
    }
    .history-card {
      background: #181c23;
      border-radius: 18px;
      box-shadow: 0 2px 12px #0006;
      padding: 18px 12px 18px 12px;
      margin: 0 0 18px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 480px;
      box-sizing: border-box;
      margin-bottom: 18px;
      padding-bottom: 10px;
      flex-shrink: 0;
    }
    .history-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: #FFD600;
      margin-bottom: 18px;
      text-align: center;
    }
    .history-empty {
      color: #fff;
      font-size: 1.08rem;
      opacity: 0.7;
      text-align: center;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
      overflow-x: auto;
      display: block;
      min-width: 320px;
      box-sizing: border-box;
    }
    .history-table th, .history-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #23272f;
      min-width: 60px;
    }
    .history-table th {
      font-weight: 600;
      color: #FFD600;
    }
    .history-table tr:last-child td {
      border-bottom: none;
    }
    .history-btn {
      margin: 24px auto 0 auto;
      display: block;
      background: #FFD600;
      color: #181c23;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      padding: 14px 0;
      font-size: 1.08rem;
      cursor: pointer;
      box-shadow: 0 2px 8px #FFD60044;
      transition: filter 0.2s;
      width: 100%;
      max-width: 320px;
    }
    .history-btn:hover {
      filter: brightness(1.1);
    }
    .history-modal-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.55);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .history-modal {
      background: #181c23;
      border-radius: 18px;
      box-shadow: 0 4px 32px #000a;
      padding: 24px 18px 18px 18px;
      min-width: 280px;
      max-width: 98vw;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      min-width: 160px;
      max-width: 98vw;
      border-radius: 10px;
      padding: 10px 2vw 10px 2vw;
    }
    .history-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .close-history-btn {
      background: none;
      border: none;
      color: #FFD600;
      font-size: 2rem;
      font-weight: 700;
      cursor: pointer;
      line-height: 1;
      padding: 0 8px;
      transition: color 0.2s;
    }
    .close-history-btn:hover {
      color: #e53935;
    }
    @media (max-width: 900px) {
      .container {
        max-width: 98vw;
        border-radius: 12px;
        box-shadow: 0 2px 12px #0006;
      }
      .chart-card, .trade-panel-card, .history-card {
        max-width: 98vw;
        border-radius: 12px;
      }
      .history-modal {
        min-width: 220px;
        max-width: 98vw;
        border-radius: 12px;
      }
    }
    @media (max-width: 600px), (max-device-width: 600px) {
      .container {
        max-width: 100vw;
        width: 100vw;
        min-height: 100vh;
        padding: 0 0 0 0;
        border-radius: 0;
        box-shadow: none;
        gap: 10px;
      }
      .top-bar {
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 6px;
        padding: 18px 8px 10px 8px;
        margin-top: 96px;
        min-height: 48px;
        width: 95%;
        margin-left: auto;
        margin-right: auto;
      }
      .profile-left {
        gap: 10px;
      }
      .profile-avatar {
        width: 40px;
        height: 40px;
      }
      .profile-username {
        font-size: 1.35rem;
      }
      .profile-actions {
        gap: 6px;
      }
      .logout-btn {
        padding: 6px 12px;
        font-size: 0.95rem;
      }
      .balance-card {
        padding: 14px 4vw 10px 4vw;
        border-radius: 10px;
        margin: 0 4vw 10px 4vw;
        margin-bottom: 10px;
      }
      .balance-amount {
        font-size: 1.2rem;
      }
      .balance-label {
        font-size: 0.95rem;
        margin-bottom: 10px;
      }
      .balance-actions button {
        font-size: 0.95rem;
        padding: 8px 10px;
        border-radius: 7px;
      }
      .chart-section {
        border-radius: 8px;
        margin: 14px 0 18px 0;
        padding: 6px 0 24px 0;
        margin-bottom: 32px;
        border-bottom: 2px solid #23272f;
      }
      #chart {
        height: 160px;
      }
      .amount-section {
        gap: 6px;
        margin-bottom: 10px;
      }
      .amount-btn {
        font-size: 0.98rem;
        padding: 7px 10px;
        border-radius: 7px;
      }
      .custom-amount-input {
        width: 60px;
        font-size: 0.98rem;
        padding: 7px 6px;
        border-radius: 7px;
      }
      .bet-section {
        gap: 10px;
        margin-top: 6px;
      }
      .bet-btn {
        font-size: 1rem;
        padding: 10px 16px;
        border-radius: 8px;
      }
      .bet-info-bar {
        font-size: 0.98rem;
        padding: 7px 8px;
        border-radius: 8px 8px 0 0;
        margin-top: -12px;
      }
      .bet-timer {
        font-size: 1rem;
        padding: 2px 7px;
        border-radius: 6px;
        min-width: 32px;
      }
      .bet-status {
        font-size: 1rem;
        margin-top: 12px;
      }
      .chart-card {
        border-radius: 10px;
        padding: 8px 2vw 32px 2vw;
        margin-bottom: 72px;
        min-height: 180px;
      }
      .trade-panel-card {
        border-radius: 10px;
        padding: 8px 2vw 10px 2vw;
        margin-bottom: 18px;
      }
      .open-trade-bar {
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 0.95rem;
      }
      .trade-timer {
        font-size: 1rem;
        padding: 2px 7px;
        border-radius: 6px;
        min-width: 32px;
      }
      .notification-bar {
        padding: 8px 10px;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: background 0.2s, color 0.2s;
      }
      .history-card {
        border-radius: 10px;
        padding: 8px 2vw 10px 2vw;
        margin-bottom: 10px;
      }
      .history-title {
        font-size: 1rem;
        margin-bottom: 10px;
      }
      .history-empty {
        font-size: 0.95rem;
      }
      .history-table th, .history-table td {
        padding: 6px 8px;
        font-size: 0.95rem;
      }
      .amount-section, .bet-section {
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }
      .amount-btn, .bet-btn {
        min-width: 90px;
        font-size: 0.98rem;
        min-height: 36px;
      }
    }
    @media (max-width: 400px) {
      .top-bar {
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 4px;
        padding: 10px 2vw 2px 2vw;
        margin-top: 64px;
        min-height: 36px;
        width: 95%;
        margin-left: auto;
        margin-right: auto;
      }
      .profile-avatar {
        width: 28px;
        height: 28px;
      }
      .profile-username {
        font-size: 1.08rem;
      }
      .logout-btn {
        padding: 5px 8px;
        font-size: 0.9rem;
      }
      .container {
        padding: 0 0 0 0;
        border-radius: 0;
        gap: 6px;
      }
      .balance-card {
        padding: 8px 2vw 8px 2vw;
        border-radius: 6px;
        margin: 0 2vw 10px 2vw;
        margin-bottom: 8px;
      }
      .chart-card, .trade-panel-card, .history-card {
        border-radius: 6px;
        padding-left: 1vw;
        padding-right: 1vw;
        margin-bottom: 8px;
        gap: 4px;
      }
      .history-modal {
        min-width: 100px;
        border-radius: 6px;
        padding: 6px 1vw 6px 1vw;
      }
      .amount-section, .bet-section {
        gap: 4px;
        margin-bottom: 6px;
      }
      .amount-btn, .bet-btn {
        min-width: 70px;
        font-size: 0.95rem;
        min-height: 32px;
      }
    }
    @media (max-width: 350px) {
      .container {
        gap: 4px;
      }
      .balance-card, .chart-card, .trade-panel-card, .history-card {
        margin-bottom: 4px;
        padding-bottom: 4px;
        gap: 2px;
      }
      .amount-section, .bet-section {
        gap: 2px;
        margin-bottom: 2px;
      }
      .amount-btn, .bet-btn {
        min-width: 50px;
        font-size: 0.9rem;
        min-height: 24px;
      }
      .history-table th, .history-table td {
        padding: 4px 4px;
        min-width: 40px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    const { useState, useEffect, useRef } = React;

    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDODDYhP7sBCXMhT52P5vuh7naR-GgA3dU",
      authDomain: "trade-master-a9a4d.firebaseapp.com",
      projectId: "trade-master-a9a4d",
      storageBucket: "trade-master-a9a4d.firebasestorage.app",
      messagingSenderId: "798009169646",
      appId: "1:798009169646:web:d5c6d82f2ac878900f85ff"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Helper: format currency
    function formatCurrency(val) {
      return '₹' + Number(val).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Helper: generate next candle (unpredictable, but realistic)
    function generateNextCandle(prev) {
      const baseVol = 2 + Math.random() * 8;
      let open = prev.close;
      let close = open + (Math.random() - 0.5) * baseVol;
      if (Math.random() < 0.15) close += (Math.random() - 0.5) * 40;
      if (Math.random() < 0.03) close += (Math.random() - 0.5) * 120;
      close = Math.max(1, close);
      const high = Math.max(open, close) + Math.random() * baseVol * 1.5;
      const low = Math.min(open, close) - Math.random() * baseVol * 1.5;
      return {
        time: prev.time + 60,
        open: parseFloat(open.toFixed(2)),
        high: parseFloat(high.toFixed(2)),
        low: parseFloat(low.toFixed(2)),
        close: parseFloat(close.toFixed(2)),
      };
    }

    // Login/Register UI
    function LoginScreen() {
      // Google login handler
      const handleGoogleLogin = async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          const result = await auth.signInWithPopup(provider);
          const user = result.user;
          // Always update user doc with latest info (merge: true keeps balance if exists)
          const userRef = db.collection('users').doc(user.uid);
          const doc = await userRef.get();
          if (!doc.exists) {
            // New user, set balance to 0
            await userRef.set({
              uid: user.uid,
              name: user.displayName,
              email: user.email,
              photoURL: user.photoURL,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              balance: 0
            });
          } else {
            // Existing user, update info but don't touch balance
            await userRef.set({
              uid: user.uid,
              name: user.displayName,
              email: user.email,
              photoURL: user.photoURL,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
          }
        } catch (e) {
          alert('Google login failed: ' + e.message);
        }
      };
      return (
        React.createElement('div', {
          style: {
            minHeight: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', background: '#10131a', color: '#fff', fontFamily: 'Poppins, Arial, sans-serif'
          }
        },
          React.createElement('div', {
            style: {
              background: '#181c23', borderRadius: 18, boxShadow: '0 2px 12px #0006', padding: '38px 28px', minWidth: 280, maxWidth: '95vw', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 18
            }
          },
            React.createElement('img', { src: 'logo.png', alt: 'Logo', style: { width: 64, height: 64, borderRadius: 16, marginBottom: 12, background: '#fff' } }),
            React.createElement('div', { style: { fontWeight: 700, fontSize: '1.35rem', color: '#FFD600', marginBottom: 8 } }, 'Welcome to Royal Trader'),
            React.createElement('div', { style: { fontSize: '1.08rem', color: '#fff', opacity: 0.8, marginBottom: 18, textAlign: 'center' } }, 'Login or register to continue'),
            React.createElement('button', {
              onClick: handleGoogleLogin,
              style: {
                background: '#fff', color: '#181c23', fontWeight: 700, border: 'none', borderRadius: 8, padding: '12px 28px', fontSize: '1.08rem', cursor: 'pointer', boxShadow: '0 2px 8px #FFD60044', display: 'flex', alignItems: 'center', gap: 10
              }
            },
              React.createElement('img', { src: 'https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_2013_Google.png', alt: 'Google', style: { width: 22, height: 22, borderRadius: 4, background: '#fff' } }),
              'Continue with Google'
            )
          )
        )
      );
    }

    function App({ hideTopBar, user, forcedGraph }) {
      // State
      const [balance, setBalance] = useState(10000);
      const [amount, setAmount] = useState(100);
      const [customAmount, setCustomAmount] = useState('');
      const [selectedAmount, setSelectedAmount] = useState(100);
      const [openTrade, setOpenTrade] = useState(null); // { direction, amount, entryPrice, entryTime, resolveTime }
      const [tradeHistory, setTradeHistory] = useState([]); // [{...openTrade, result, exitPrice, pnl}]
      const [depositHistory, setDepositHistory] = useState([]); // [{amount, upi, time}]
      const [withdrawHistory, setWithdrawHistory] = useState([]); // [{amount, upi, time}]
      const [notification, setNotification] = useState('');
      const [showHistory, setShowHistory] = useState(false);
      const [activeHistoryTab, setActiveHistoryTab] = useState('trade'); // 'trade', 'deposit', 'withdraw'
      const [showDeposit, setShowDeposit] = useState(false);
      const [showWithdraw, setShowWithdraw] = useState(false);
      // Deposit modal state
      const depositAmounts = [50, 100, 200, 500, 1000, 2000];
      const [depositAmount, setDepositAmount] = useState(depositAmounts[0]);
      const [depositCustomAmount, setDepositCustomAmount] = useState('');
      const [depositUpi, setDepositUpi] = useState('');
      // Withdraw modal state
      const [withdrawAmount, setWithdrawAmount] = useState('');
      const [withdrawUpi, setWithdrawUpi] = useState('');
      const [withdrawError, setWithdrawError] = useState('');
      const chartRef = useRef();
      const seriesRef = useRef();
      const dataRef = useRef([]);
      const timerRef = useRef();
      const [tradeTimer, setTradeTimer] = useState(0);
      const [users, setUsers] = React.useState([]);
      const [userSearch, setUserSearch] = React.useState('');
      // Add isInstalled state
      const [isInstalled, setIsInstalled] = React.useState(false);
      // In App state:
      const [showInstallModal, setShowInstallModal] = useState(false);
      // Add mustDeposit state
      const [mustDeposit, setMustDeposit] = useState(false);
      // Add local state for deposit notice
      const [showDepositNotice, setShowDepositNotice] = useState(false);
      // Add state for deposit request submitted message
      const [depositSubmitted, setDepositSubmitted] = useState(false);
      // Track previous mustDeposit to only show notice on transition
      const prevMustDeposit = React.useRef(false);
      // Add state for deposit request submitted message (user-initiated only)
      const [showDepositSubmittedMsg, setShowDepositSubmittedMsg] = useState(false);

      // Enforce deposit requirement based on balance
      useEffect(() => {
        if (!user) return;
        if (balance <= 0) {
          setMustDeposit(true);
          setShowDeposit(true);
          // Only show notice if mustDeposit just became true
          if (!prevMustDeposit.current) setShowDepositNotice(true);
          setDepositSubmitted(false); // Reset on new login or balance change
        } else {
          setMustDeposit(false);
          setShowDepositNotice(false);
          setDepositSubmitted(false);
        }
        prevMustDeposit.current = balance <= 0;
      }, [user, balance]);

      // Auto-hide the deposit-required notification after 4 seconds
      useEffect(() => {
        if (mustDeposit && !notification && showDepositNotice) {
          const timer = setTimeout(() => setShowDepositNotice(false), 4000);
          return () => clearTimeout(timer);
        }
      }, [mustDeposit, notification, showDepositNotice]);

      // Auto-hide the deposit submitted message after 8 seconds
      useEffect(() => {
        if (depositSubmitted) {
          const timer = setTimeout(() => setDepositSubmitted(false), 12000);
          return () => clearTimeout(timer);
        }
      }, [depositSubmitted]);

      // Load history from Firestore on login (REAL-TIME)
      useEffect(() => {
        if (!user) return;
        // Trade history
        const unsubTrade = db.collection('users').doc(user.uid).collection('tradeHistory')
          .orderBy('entryTime', 'desc').limit(8)
          .onSnapshot(snap => {
            setTradeHistory(snap.docs.map(doc => doc.data()));
          });
        // Deposit history
        const unsubDeposit = db.collection('users').doc(user.uid).collection('depositHistory')
          .orderBy('time', 'desc').limit(8)
          .onSnapshot(snap => {
            setDepositHistory(snap.docs.map(doc => doc.data()));
          });
        // Withdraw history
        const unsubWithdraw = db.collection('users').doc(user.uid).collection('withdrawHistory')
          .orderBy('time', 'desc').limit(8)
          .onSnapshot(snap => {
            setWithdrawHistory(snap.docs.map(doc => doc.data()));
          });
        return () => {
          unsubTrade();
          unsubDeposit();
          unsubWithdraw();
        };
      }, [user]);

      // Load balance from Firestore on login (REAL-TIME)
      useEffect(() => {
        if (!user) return;
        const unsub = db.collection('users').doc(user.uid)
          .onSnapshot(doc => {
            if (doc.exists && doc.data().balance !== undefined) {
              setBalance(doc.data().balance);
            } else {
              db.collection('users').doc(user.uid).set({ balance: 0 }, { merge: true });
              setBalance(0);
            }
          });
        return () => unsub();
      }, [user]);

      // Initial candle data
      useEffect(() => {
        const now = Math.floor(Date.now() / 1000);
        let t = now - 60 * 60;
        let price = 100 + Math.random() * 10;
        const candles = [];
        for (let i = 0; i < 60; i++) {
          const open = price;
          const close = open + (Math.random() - 0.5) * 2;
          const high = Math.max(open, close) + Math.random() * 1.2;
          const low = Math.min(open, close) - Math.random() * 1.2;
          candles.push({
            time: t,
            open: parseFloat(open.toFixed(2)),
            high: parseFloat(high.toFixed(2)),
            low: parseFloat(low.toFixed(2)),
            close: parseFloat(close.toFixed(2)),
          });
          t += 60;
          price = close;
        }
        dataRef.current = candles;
      }, []);

      // Chart setup
      useEffect(() => {
        if (!window.LightweightCharts) return;
        if (chartRef.current) return;
        const chart = window.LightweightCharts.createChart(document.getElementById('chart'), {
          layout: {
            background: { color: '#181c23' },
            textColor: '#fff',
          },
          grid: {
            vertLines: { color: '#23272f' },
            horzLines: { color: '#23272f' },
          },
          timeScale: {
            timeVisible: true,
            secondsVisible: false,
            borderColor: '#23272f',
            rightOffset: 8,
            shiftVisibleRangeOnNewBar: false,
            barSpacing: 18,
          },
          rightPriceScale: {
            borderColor: '#23272f',
          },
          width: document.getElementById('chart').offsetWidth,
          height: 260,
        });
        chart.timeScale().applyOptions({ barSpacing: 18 });
        const candleSeries = chart.addSeries(
          window.LightweightCharts.CandlestickSeries, {
            upColor: '#4caf50',
            downColor: '#e53935',
            borderUpColor: '#4caf50',
            borderDownColor: '#e53935',
            wickUpColor: '#4caf50',
            wickDownColor: '#e53935',
          }
        );
        candleSeries.setData(dataRef.current);
        chartRef.current = chart;
        seriesRef.current = candleSeries;
        window.addEventListener('resize', () => {
          chart.applyOptions({ width: document.getElementById('chart').offsetWidth });
          chart.timeScale().applyOptions({ barSpacing: 18 });
        });
        // Center the running candle in the chart frame
        if (chartRef.current && chartRef.current.timeScale) {
          // 4 means the latest candle will be at the center if visibleBars is 8
          chartRef.current.timeScale().scrollToPosition(-4, true);
        }
      }, []);

      // Chart update (add new candle every 4s)
      // Chart update: live candle for 15s, update every 1s
useEffect(() => {
  if (!seriesRef.current) return;
  if (forcedGraph && forcedGraph.paused) return; // Pause chart updates if paused

  let candleTimer;
  let updateTimer;
  let currentCandle = null;

  function startNewCandle() {
    const last = dataRef.current[dataRef.current.length - 1];
    const nowTime = last ? last.time + 15 : Math.floor(Date.now() / 1000);
    const open = last ? last.close : 100;
    currentCandle = {
      time: nowTime,
      open: open,
      high: open,
      low: open,
      close: open,
    };
    dataRef.current.push(currentCandle);
    if (dataRef.current.length > 120) dataRef.current.shift();
    seriesRef.current.setData(dataRef.current);
    const visibleBars = 8; // ya jitni candles aapko dikhani hain
if (chartRef.current && chartRef.current.timeScale) {
  chartRef.current.timeScale().setVisibleLogicalRange({
    from: Math.max(0, dataRef.current.length - visibleBars - 4), // -4 for center
    to: Math.max(0, dataRef.current.length + 1)
  });
}
  }

  function updateCurrentCandle() {
    if (!currentCandle) return;
    let change;
    if (forcedGraph && forcedGraph.direction && forcedGraph.endTime > Date.now()) {
  // Move in forced direction
  change = (Math.random() + 0.5) * 0.8 * (forcedGraph.direction === 'up' ? 1 : -1); // SLOWER
  } else {
    change = (Math.random() - 0.5) * 0.8; // SLOWER
  }
    currentCandle.close = Math.max(1, parseFloat((currentCandle.close + change).toFixed(2)));
    currentCandle.high = Math.max(currentCandle.high, currentCandle.close);
    currentCandle.low = Math.min(currentCandle.low, currentCandle.close);
    // Update last candle in dataRef
    dataRef.current[dataRef.current.length - 1] = { ...currentCandle };
    seriesRef.current.setData(dataRef.current);
    const visibleBars = 8; // ya jitni candles aapko dikhani hain
if (chartRef.current && chartRef.current.timeScale) {
  chartRef.current.timeScale().setVisibleLogicalRange({
    from: Math.max(0, dataRef.current.length - visibleBars - 4), // -4 for center
    to: Math.max(0, dataRef.current.length + 1)
  });
}
  }

  // Start first live candle
  startNewCandle();

  // Update candle every 1s
  updateTimer = setInterval(updateCurrentCandle, 4000);

  // Every 20s, fix current candle and start new one
  candleTimer = setInterval(() => {
    startNewCandle();
  }, 20000);

  return () => {
    clearInterval(updateTimer);
    clearInterval(candleTimer);
  };
}, [seriesRef.current, forcedGraph]);

      // Trade timer and resolve logic
      useEffect(() => {
        if (!openTrade) return;
        setTradeTimer(60);
        timerRef.current && clearInterval(timerRef.current);
        timerRef.current = setInterval(() => {
          setTradeTimer(prev => {
            if (prev <= 1) {
              clearInterval(timerRef.current);
              // Resolve trade
              const lastCandle = dataRef.current[dataRef.current.length - 1];
              let win = false;
              if (openTrade.direction === 'up') win = lastCandle.close > openTrade.entryPrice;
              else win = lastCandle.close < openTrade.entryPrice;
              let pnl = win ? openTrade.amount * 1.8 : 0; // Profit is 1.8x on win, 0 on loss (amount already deducted)
              if (win) {
                setBalance(bal => {
                  const newBal = bal + openTrade.amount * 1.8;
                  db.collection('users').doc(user.uid).update({ balance: newBal });
                  return newBal;
                });
              } else {
                // On loss, balance already deducted
                db.collection('users').doc(user.uid).update({ balance });
              }
              const newTrade = {
                ...openTrade,
                exitPrice: lastCandle.close,
                result: win ? 'win' : 'loss',
                pnl: win ? openTrade.amount * 1.8 : -openTrade.amount,
              };
              // Store in Firestore
              if (user) {
                const ref = db.collection('users').doc(user.uid).collection('tradeHistory');
                ref.add(newTrade).then(() => {
                  // Keep only last 8
                  ref.orderBy('entryTime', 'desc').get().then(snap => {
                    const docs = snap.docs;
                    if (docs.length > 8) {
                      docs.slice(8).forEach(d => d.ref.delete());
                    }
                  });
                });
                // Clear openTrade in Firestore
                db.collection('users').doc(user.uid).update({ openTrade: firebase.firestore.FieldValue.delete() });
              }
              setTradeHistory(hist => [newTrade, ...hist].slice(0, 8));
              setNotification({
                message: win ? `You WON! +${formatCurrency(openTrade.amount * 1.8)}` : `You LOST! -${formatCurrency(openTrade.amount)}`,
                type: win ? 'win' : 'loss'
              });
              setOpenTrade(null);
              setTimeout(() => setNotification(''), 3000);
              return 0;
            }
            return prev - 1;
          });
        }, 1000);
        return () => clearInterval(timerRef.current);
      }, [openTrade]);

      // Amount selection
      const amounts = [50, 100, 500, 1000, 5000, 10000];
      const handleAmountClick = amt => {
        setSelectedAmount(amt);
        setCustomAmount('');
        setAmount(amt);
      };
      const handleCustomAmount = e => {
        const val = e.target.value.replace(/[^0-9.]/g, '');
        setCustomAmount(val);
        setSelectedAmount(null);
        setAmount(Number(val) || 0);
      };

      // Deposit/Withdraw
      // Deposit
      const handleDeposit = () => {
        setShowDeposit(true);
        setDepositAmount(depositAmounts[0]);
        setDepositCustomAmount('');
        setDepositUpi('');
        setShowDepositSubmittedMsg(false); // Reset message on open
      };
      const confirmDeposit = () => {
        const finalDepositAmount = depositCustomAmount ? Number(depositCustomAmount) : depositAmount;
        if (!finalDepositAmount || !depositUpi) return;
        setDepositSubmitted(true); // Show submitted message (for mustDeposit)
        // Show user-initiated message only if not mustDeposit
        if (!mustDeposit) {
          setShowDepositSubmittedMsg(true);
          setTimeout(() => setShowDepositSubmittedMsg(false), 3000);
        }
        const newDeposit = { amount: finalDepositAmount, upi: depositUpi, time: Date.now(), status: 'pending' };
        if (user) {
          const ref = db.collection('users').doc(user.uid).collection('depositHistory');
          ref.add(newDeposit).then(() => {
            ref.orderBy('time', 'desc').get().then(snap => {
              const docs = snap.docs;
              if (docs.length > 8) {
                docs.slice(8).forEach(d => d.ref.delete());
              }
            });
          });
        }
        setDepositHistory(hist => [newDeposit, ...hist].slice(0, 8));
        setDepositAmount(depositAmounts[0]);
        setDepositCustomAmount('');
        setDepositUpi('');
        
        // Send deposit request to admin via Formspree
        const formData = new FormData();
        formData.append('amount', finalDepositAmount);
        formData.append('upi', depositUpi);
        formData.append('userName', user ? user.displayName || 'Unknown User' : 'Unknown User');
        formData.append('userEmail', user ? user.email || 'No Email' : 'No Email');
        formData.append('userId', user ? user.uid : 'Unknown');
        formData.append('timestamp', new Date().toLocaleString('en-IN'));
        formData.append('type', 'Deposit Request');
        
        fetch('https://formspree.io/f/xwpqbqvo', {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        }).catch(error => {
          console.log('Formspree deposit submission error:', error);
        });
      };
      // Withdraw
      const handleWithdraw = () => {
        setShowWithdraw(true);
        setWithdrawAmount('');
        setWithdrawUpi('');
        setWithdrawError('');
      };
      const validateWithdraw = (amount) => {
        if (!amount) return '';
        const val = Number(amount);
        if (isNaN(val)) return 'Enter a valid number';
        if (val < 200) return 'Minimum withdraw is ₹200';
        if (val > 100000) return 'Maximum withdraw is ₹1,00,000';
        return '';
      };
      const onWithdrawAmountChange = (e) => {
        const val = e.target.value.replace(/[^0-9]/g, '');
        setWithdrawAmount(val);
        setWithdrawError(validateWithdraw(val));
      };
      const confirmWithdraw = () => {
        if (!withdrawAmount || !withdrawUpi || withdrawError) return;
        // Check if user has enough balance
        if (Number(withdrawAmount) > balance) {
          setNotification('Insufficient balance!');
          setTimeout(() => setNotification(''), 4000);
          return;
        }
        setShowWithdraw(false);
        setNotification('Withdrawal request submitted! Waiting for admin approval.');
        setTimeout(() => setNotification(''), 4000);
        const newWithdraw = { amount: withdrawAmount, upi: withdrawUpi, time: Date.now(), status: 'pending' };
        if (user) {
          const ref = db.collection('users').doc(user.uid).collection('withdrawHistory');
          ref.add(newWithdraw).then(() => {
            ref.orderBy('time', 'desc').get().then(snap => {
              const docs = snap.docs;
              if (docs.length > 8) {
                docs.slice(8).forEach(d => d.ref.delete());
              }
            });
          });
          // Deduct balance immediately on withdrawal request
          setBalance(bal => {
            const newBal = Number(bal) - Number(withdrawAmount);
            db.collection('users').doc(user.uid).update({ balance: newBal });
            return newBal;
          });
        }
        setWithdrawHistory(hist => [newWithdraw, ...hist].slice(0, 8));
        setWithdrawAmount('');
        setWithdrawUpi('');
        setWithdrawError('');
        
        // Send withdrawal request to admin via Formspree
        const formData = new FormData();
        formData.append('amount', withdrawAmount);
        formData.append('upi', withdrawUpi);
        formData.append('userName', user ? user.displayName || 'Unknown User' : 'Unknown User');
        formData.append('userEmail', user ? user.email || 'No Email' : 'No Email');
        formData.append('userId', user ? user.uid : 'Unknown');
        formData.append('timestamp', new Date().toLocaleString('en-IN'));
        formData.append('type', 'Withdrawal Request');
        
        fetch('https://formspree.io/f/xrblklek', {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        }).catch(error => {
          console.log('Formspree withdrawal submission error:', error);
        });
      };

      // Place trade
      const handleTrade = dir => {
        if (openTrade) return;
        if (amount < 1 || amount > balance) {
          setNotification('Invalid amount!');
          return;
        }
        const lastCandle = dataRef.current[dataRef.current.length - 1];
        setBalance(bal => {
          const newBal = bal - amount;
          db.collection('users').doc(user.uid).update({ balance: newBal });
          return newBal;
        }); // Deduct immediately
        const newOpenTrade = {
          direction: dir,
          amount,
          entryPrice: lastCandle.close,
          entryTime: Date.now(),
          entryDate: new Date().toLocaleDateString('en-GB'), // Add readable date
          resolveTime: Date.now() + 60000,
        };
        setOpenTrade(newOpenTrade);
        // Write openTrade to Firestore
        db.collection('users').doc(user.uid).set({ openTrade: newOpenTrade }, { merge: true });
      };

      // Top bar
      const TopBar = () => (
        React.createElement('div', { className: 'top-bar' },
          React.createElement('div', { className: 'profile-left' },
            React.createElement('img', { src: 'logo.jpeg', className: 'profile-avatar', alt: 'logo' }),
            React.createElement('span', { className: 'profile-username' }, 'Royal Trader')
          ),
          React.createElement('div', { className: 'profile-actions' },
            React.createElement('button', { className: 'logout-btn' }, 'Logout')
          )
        )
      );

      // Notification
      const Notification = () => {
        if (!notification) return null;
        let message = notification;
        let type = '';
        if (typeof notification === 'object' && notification.message) {
          message = notification.message;
          type = notification.type;
        }
        return React.createElement('div', { className: `notification-bar${type ? ' ' + type : ''}` }, message);
      };

      // Trade history modal/card
      const TradeHistoryModal = () => showHistory && (
        React.createElement('div', { className: 'history-modal-bg', onClick: () => setShowHistory(false) },
          React.createElement('div', { className: 'history-modal', onClick: e => e.stopPropagation() },
            React.createElement('div', { className: 'history-title-row' },
              React.createElement('div', { className: 'history-title' }, 'History'),
              React.createElement('button', { className: 'close-history-btn', onClick: () => setShowHistory(false) }, '×')
            ),
            // Tabs
            React.createElement('div', { style: { display: 'flex', justifyContent: 'center', gap: 10, marginBottom: 18 } },
              ['trade', 'deposit', 'withdraw'].map(tab =>
                React.createElement('button', {
                  key: tab,
                  onClick: () => setActiveHistoryTab(tab),
                  style: {
                    background: activeHistoryTab === tab ? '#FFD600' : '#181c23',
                    color: activeHistoryTab === tab ? '#181c23' : '#FFD600',
                    fontWeight: 700,
                    border: '2px solid #FFD600',
                    borderRadius: 8,
                    padding: '8px 18px',
                    fontSize: '1.05rem',
                    cursor: 'pointer',
                    transition: 'background 0.2s, color 0.2s',
                    minWidth: 90
                  }
                },
                  tab === 'trade' ? 'Trades' : tab === 'deposit' ? 'Deposits' : 'Withdrawals'
                )
              )
            ),
            // Section content
            activeHistoryTab === 'trade' && (
              React.createElement('div', null,
                React.createElement('div', { className: 'history-title', style: { fontSize: '1.08rem', marginBottom: 8 } }, 'Last 10 Trades'),
                tradeHistory.length === 0 ? (
                  React.createElement('div', { className: 'history-empty' }, 'No trades yet.')
                ) : (
                  React.createElement('table', { className: 'history-table' },
                    React.createElement('thead', null,
                      React.createElement('tr', null,
                        React.createElement('th', null, 'Time'),
                        React.createElement('th', null, 'Direction'),
                        React.createElement('th', null, 'Amount'),
                        React.createElement('th', null, 'P&L')
                      )
                    ),
                    React.createElement('tbody', null,
                      tradeHistory.slice(0, 10).map((t, i) => React.createElement('tr', { key: i },
                        React.createElement('td', null, t.entryTime ? new Date(t.entryTime).toLocaleTimeString() : ''),
                        React.createElement('td', null, t.direction ? t.direction.toUpperCase() : ''),
                        React.createElement('td', null, formatCurrency(t.amount)),
                        React.createElement('td', { style: { color: t.pnl >= 0 ? '#4caf50' : '#e53935', fontWeight: 600 } }, (t.pnl >= 0 ? '+' : '') + formatCurrency(t.pnl))
                      ))
                    )
                  )
                )
              )
            ),
            activeHistoryTab === 'deposit' && (
              React.createElement('div', null,
                React.createElement('div', { className: 'history-title', style: { fontSize: '1.08rem', marginBottom: 8 } }, 'Last 10 Deposits'),
                depositHistory.length === 0 ? (
                  React.createElement('div', { className: 'history-empty' }, 'No deposits yet.')
                ) : (
                  React.createElement('table', { className: 'history-table' },
                    React.createElement('thead', null,
                      React.createElement('tr', null,
                        React.createElement('th', null, 'Time'),
                        React.createElement('th', null, 'UPI ID'),
                        React.createElement('th', null, 'Amount'),
                        React.createElement('th', null, 'Status'),
                      )
                    ),
                    React.createElement('tbody', null,
                      depositHistory.slice(0, 10).map((d, i) => React.createElement('tr', { key: i },
                        React.createElement('td', null, d.time ? new Date(d.time).toLocaleTimeString() : ''),
                        React.createElement('td', null, d.upi),
                        React.createElement('td', { style: { color: '#4caf50', fontWeight: 600 } }, formatCurrency(d.amount)),
                        React.createElement('td', null,
                          React.createElement('span', {
                            style: {
                              color:
                                (d.status && d.status.toLowerCase() === 'pending') ? '#FFD600' :
                                (d.status && d.status.toLowerCase() === 'success') ? '#43a047' :
                                (d.status && d.status.toLowerCase() === 'rejected') ? '#e53935' :
                                '#fff',
                              fontWeight: 700
                            }
                          }, d.status ? d.status.charAt(0).toUpperCase() + d.status.slice(1) : 'Pending')
                        )
                      ))
                    )
                  )
                )
              )
            ),
            activeHistoryTab === 'withdraw' && (
              React.createElement('div', null,
                React.createElement('div', { className: 'history-title', style: { fontSize: '1.08rem', marginBottom: 8 } }, 'Last 10 Withdrawals'),
                withdrawHistory.length === 0 ? (
                  React.createElement('div', { className: 'history-empty' }, 'No withdrawals yet.')
                ) : (
                  React.createElement('table', { className: 'history-table' },
                    React.createElement('thead', null,
                      React.createElement('tr', null,
                        React.createElement('th', null, 'Time'),
                        React.createElement('th', null, 'UPI ID'),
                        React.createElement('th', null, 'Amount'),
                        React.createElement('th', null, 'Status'),
                      )
                    ),
                    React.createElement('tbody', null,
                      withdrawHistory.slice(0, 10).map((w, i) => React.createElement('tr', { key: i },
                        React.createElement('td', null, w.time ? new Date(w.time).toLocaleTimeString() : ''),
                        React.createElement('td', null, w.upi),
                        React.createElement('td', { style: { color: '#4caf50', fontWeight: 600 } }, formatCurrency(w.amount)),
                        React.createElement('td', null,
                          React.createElement('span', {
                            style: {
                              color:
                                (w.status && w.status.toLowerCase() === 'pending') ? '#FFD600' :
                                (w.status && w.status.toLowerCase() === 'success') ? '#43a047' :
                                (w.status && w.status.toLowerCase() === 'rejected') ? '#e53935' :
                                '#fff',
                              fontWeight: 700
                            }
                          }, w.status ? w.status.charAt(0).toUpperCase() + w.status.slice(1) : 'Pending')
                        )
                      ))
                    )
                  )
                )
              )
            )
          )
        )
      );

      // Main render
      // Calculate total profit and last 24 hours profit
      const totalProfit = tradeHistory.reduce((sum, t) => sum + (typeof t.pnl === 'number' ? t.pnl : 0), 0);
      const now = Date.now();
      const profit24h = tradeHistory.filter(t => t.entryTime && (now - t.entryTime < 24 * 60 * 60 * 1000)).reduce((sum, t) => sum + (typeof t.pnl === 'number' ? t.pnl : 0), 0);
      return (
        React.createElement('div', { className: 'container' },
          !hideTopBar && React.createElement(TopBar),
          React.createElement(Notification),
          // Auto-hide the deposit-required notification after 4 seconds
          mustDeposit && !notification && (
            React.createElement('div', {
              className: 'notification-bar',
              style: {
                position: 'fixed',
                top: 10,
                left: '50%',
                transform: 'translateX(-50%)',
                background: '#FFD600',
                color: '#181c23',
                padding: '18px 10px',
                borderRadius: '12px',
                boxShadow: '0 4px 16px #FFD60044',
                zIndex: 10000,
                fontWeight: 700,
                fontSize: '1.15rem',
                textAlign: 'center',
                marginTop: '10px',
                transition: 'background 0.2s',
                minWidth: 'unset',
                maxWidth: '420px',
              }
            },
              depositSubmitted
                ? 'Deposite request submitted successfully. Your amount will get added in next 20 to 30 minutes. After that you can access the app. Thank you...'
                : 'Deposite to Enter in App.'
            )
          ),
          React.createElement('div', { className: 'balance-card' },
            React.createElement('div', {
              style: {
                width: '100%',
                display: 'flex',
                flexDirection: 'row',
                alignItems: 'center',
                justifyContent: 'space-between',
                gap: 8,
                marginBottom: 8,
                flexWrap: 'wrap'
              }
            },
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'center', minWidth: 90 } },
                React.createElement('span', { className: 'balance-amount', style: { fontSize: '1.25rem', marginBottom: 0 } }, formatCurrency(balance)),
                React.createElement('span', { className: 'balance-label', style: { fontSize: '0.98rem', marginBottom: 0, opacity: 0.7 } }, 'Wallet')
              ),
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'center', minWidth: 90 } },
                React.createElement('span', { style: { color: '#FFD600', fontWeight: 600, fontSize: '1.08rem', marginBottom: 0 } }, `${totalProfit >= 0 ? '+' : ''}${formatCurrency(totalProfit)}`),
                React.createElement('span', { style: { color: '#FFD600', fontSize: '0.98rem', opacity: 0.7 } }, 'Total Profit')
              ),
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'center', minWidth: 90 } },
                React.createElement('span', { style: { color: profit24h >= 0 ? '#4caf50' : '#e53935', fontWeight: 600, fontSize: '1.08rem', marginBottom: 0 } }, `${profit24h >= 0 ? '+' : ''}${formatCurrency(profit24h)}`),
                React.createElement('span', { style: { color: profit24h >= 0 ? '#4caf50' : '#e53935', fontSize: '0.98rem', opacity: 0.7 } }, 'Profit or Loss')
              )
            ),
            React.createElement('div', { className: 'balance-actions' },
              React.createElement('button', { onClick: handleDeposit }, 'Deposit'),
              React.createElement('button', { onClick: handleWithdraw }, 'Withdraw')
            )
          ),
          React.createElement('div', { className: 'chart-card' },
            React.createElement('div', { className: 'chart-section' },
              React.createElement('div', { id: 'chart' })
            )
          ),
          React.createElement('div', { className: 'trade-panel-card' },
            openTrade && React.createElement('div', { className: 'open-trade-bar' },
              React.createElement('span', null, `Open Trade: ${openTrade.direction.toUpperCase()} ${formatCurrency(openTrade.amount)} @ ${formatCurrency(openTrade.entryPrice)}`),
              React.createElement('span', { className: 'trade-timer' }, `${tradeTimer}s`)
            ),
            React.createElement('div', { className: 'amount-section' },
              amounts.map(amt =>
                React.createElement('button', {
                  key: amt,
                  className: 'amount-btn' + (selectedAmount === amt ? ' selected' : ''),
                  onClick: () => handleAmountClick(amt),
                  disabled: !!openTrade
                }, formatCurrency(amt))
              ),
              React.createElement('input', {
                className: 'custom-amount-input',
                type: 'number',
                min: 1,
                placeholder: 'Custom',
                value: customAmount,
                onChange: handleCustomAmount,
                disabled: !!openTrade
              })
            ),
            React.createElement('div', { className: 'bet-section' },
              React.createElement('button', {
                className: 'bet-btn up',
                onClick: () => handleTrade('up'),
                disabled: !!openTrade
              }, 'Buy (Up)'),
              React.createElement('button', {
                className: 'bet-btn down',
                onClick: () => handleTrade('down'),
                disabled: !!openTrade
              }, 'Sell (Down)')
            ),
            React.createElement('button', {
              className: 'history-btn',
              onClick: () => setShowHistory(true)
            }, 'History'),
            // Download App and Share buttons
            React.createElement('button', {
              className: 'history-btn',
              style: { marginTop: 10 },
              onClick: () => {
                if (isInstalled) {
                  setNotification(''); // clear first
                  setTimeout(() => setNotification('App already installed!'), 10);
                  setTimeout(() => setNotification(''), 3000);
                  return;
                }
                if (isIOS()) {
                  setShowInstallModal('ios');
                } else {
                  setShowInstallModal('android');
                }
              },
              disabled: isInstalled
            }, isInstalled ? 'App Installed' : 'Download App'),
            // Restore Share button
            React.createElement('button', {
              className: 'history-btn',
              style: { marginTop: 10 },
              onClick: () => {
                const shareData = {
                  title: 'TradeWell App',
                  text: 'Try this Amazing trading app!',
                  url: 'https://chipper-syrniki-d20dcc.netlify.app/'
                };
                if (navigator.share) {
                  navigator.share(shareData).catch(() => {});
                }
                // No clipboard fallback, do nothing if not supported
              }
            }, 'Share')
          ),
          React.createElement(TradeHistoryModal),
          // Deposit Modal
          showDeposit && React.createElement('div', { className: 'history-modal-bg', onClick: () => { if (!mustDeposit) setShowDeposit(false); } },
            React.createElement('div', {
              className: 'history-modal',
              onClick: e => e.stopPropagation(),
              style: { width: '95vw', maxWidth: 480, boxSizing: 'border-box', position: 'relative' }
            },
              React.createElement('div', { className: 'history-title-row' },
                React.createElement('div', { className: 'history-title' }, 'Deposit Funds'),
                !mustDeposit && React.createElement('button', { className: 'close-history-btn', onClick: () => setShowDeposit(false) }, '×')
              ),
              // Show user-initiated deposit submitted message
              !mustDeposit && showDepositSubmittedMsg && React.createElement('div', {
                style: {
                  color: '#FFD600',
                  background: '#23272f',
                  borderRadius: 8,
                  padding: '10px 0',
                  marginBottom: 10,
                  fontWeight: 700,
                  textAlign: 'center',
                  fontSize: '1.08rem',
                  border: '2px solid #FFD600',
                }
              }, 'Deposit request submitted. Waiting for admin approval.'),
              React.createElement('div', { style: { textAlign: 'center', marginBottom: 18 } },
                React.createElement('img', {
                  src: 'qr.png',
                  alt: 'QR Code',
                  style: { width: 140, height: 140, borderRadius: 12, marginBottom: 12, border: '2px solid #FFD600', background: '#fff', maxWidth: '90vw' }
                }),
                React.createElement('div', { style: { color: '#FFD600', fontWeight: 600, marginBottom: 8 } }, 'Scan QR to Pay')
              ),
              React.createElement('div', { className: 'amount-section', style: { marginBottom: 10, width: '100%', justifyContent: 'center', flexWrap: 'wrap', display: 'flex', gap: 10 } },
                depositAmounts.map(amt =>
                  React.createElement('button', {
                    key: amt,
                    className: 'amount-btn' + (depositAmount === amt && !depositCustomAmount ? ' selected' : ''),
                    onClick: () => { setDepositAmount(amt); setDepositCustomAmount(''); },
                    style: { minWidth: 70, minHeight: 36 }
                  }, `₹${amt}`)
                ),
                React.createElement('input', {
                  type: 'number',
                  min: 1,
                  placeholder: 'Custom',
                  className: 'custom-amount-input',
                  value: depositCustomAmount,
                  onChange: e => {
                    setDepositCustomAmount(e.target.value.replace(/[^0-9]/g, ''));
                    setDepositAmount(null);
                  },
                  style: { minWidth: 70, minHeight: 36 }
                })
              ),
              React.createElement('input', {
                type: 'text',
                placeholder: 'Enter your UPI ID',
                className: 'custom-amount-input',
                value: depositUpi,
                onChange: e => setDepositUpi(e.target.value),
                style: { marginBottom: 10, width: '95%' }
              }),
              React.createElement('button', {
                className: 'history-btn',
                style: { marginTop: 10, opacity: ((!depositAmount && !depositCustomAmount) || !depositUpi) ? 0.6 : 1, cursor: ((!depositAmount && !depositCustomAmount) || !depositUpi) ? 'not-allowed' : 'pointer', width: '95%' },
                onClick: confirmDeposit,
                disabled: ((!depositAmount && !depositCustomAmount) || !depositUpi)
              }, 'Confirm Deposit'),
              // Only show Logout button if mustDeposit is true
              mustDeposit && React.createElement('button', {
                className: 'logout-btn',
                style: { width: '100%', marginTop: 18, background: '#e53935', color: '#fff', fontWeight: 700, fontSize: '1.08rem', borderRadius: 8, padding: '12px 0', border: 'none', cursor: 'pointer' },
                onClick: () => {
                  if (typeof onLogout === 'function') return onLogout();
                  if (typeof handleLogout === 'function') return handleLogout();
                  if (window.firebase && window.firebase.auth) window.firebase.auth().signOut();
                }
              }, 'Logout')
            )
          ),
          // Withdraw Modal
          showWithdraw && React.createElement('div', { className: 'history-modal-bg', onClick: () => setShowWithdraw(false) },
            React.createElement('div', {
              className: 'history-modal',
              onClick: e => e.stopPropagation(),
              style: { width: '95vw', maxWidth: 480, boxSizing: 'border-box' }
            },
              React.createElement('div', { className: 'history-title-row' },
                React.createElement('div', { className: 'history-title' }, 'Withdraw Funds'),
                React.createElement('button', { className: 'close-history-btn', onClick: () => setShowWithdraw(false) }, '×')
              ),
              React.createElement('input', {
                type: 'number',
                min: 200,
                max: 100000,
                placeholder: 'Enter amount',
                className: 'custom-amount-input',
                value: withdrawAmount,
                onChange: onWithdrawAmountChange,
                style: { marginBottom: 10, width: '95%' }
              }),
              withdrawError && React.createElement('div', { style: { color: '#e53935', fontSize: '0.98rem', marginBottom: 8 } }, withdrawError),
              React.createElement('input', {
                type: 'text',
                placeholder: 'Enter your UPI ID',
                className: 'custom-amount-input',
                value: withdrawUpi,
                onChange: e => setWithdrawUpi(e.target.value),
                style: { marginBottom: 10, width: '95%' }
              }),
              React.createElement('button', {
                className: 'history-btn',
                style: { marginTop: 10, opacity: (!withdrawAmount || !withdrawUpi || withdrawError) ? 0.6 : 1, cursor: (!withdrawAmount || !withdrawUpi || withdrawError) ? 'not-allowed' : 'pointer', width: '95%' },
                onClick: confirmWithdraw,
                disabled: (!withdrawAmount || !withdrawUpi || withdrawError)
              }, 'Confirm Withdraw')
            )
          ),
          // Custom Install Modal
          showInstallModal && React.createElement('div', { className: 'history-modal-bg', onClick: () => setShowInstallModal(false) },
            React.createElement('div', {
              className: 'history-modal',
              onClick: e => e.stopPropagation(),
              style: { width: '95vw', maxWidth: 320, boxSizing: 'border-box', textAlign: 'center' }
            },
              showInstallModal === 'ios' ? (
                React.createElement(React.Fragment, null,
                  React.createElement('div', { className: 'history-title', style: { marginBottom: 18 } }, 'Install App on iOS'),
                  React.createElement('div', { style: { marginBottom: 18, color: '#FFD600', fontWeight: 600 } },
                    'To install this app on your iPhone or iPad:'
                  ),
                  React.createElement('ol', { style: { textAlign: 'left', color: '#fff', fontSize: '1.05rem', margin: '0 0 18px 0', paddingLeft: 22 } },
                    React.createElement('li', null, 'Open in Safari browser.'),
                    React.createElement('li', null, 'Tap the Share icon (square with arrow) at the bottom.'),
                    React.createElement('li', null, 'Scroll down and tap "Add to Home Screen".'),
                    React.createElement('li', null, 'Tap "Add" on the top right.')
                  ),
                  React.createElement('button', {
                    className: 'history-btn',
                    style: { width: 100, background: '#e53935', color: '#fff' },
                    onClick: () => setShowInstallModal(false)
                  }, 'Close')
                )
              ) : (
                React.createElement(React.Fragment, null,
                  React.createElement('div', { className: 'history-title', style: { marginBottom: 18 } }, 'Install App'),
                  React.createElement('div', { style: { marginBottom: 18 } }, 'Do you want to install this app on your device?'),
                  React.createElement('div', { style: { display: 'flex', gap: 16, justifyContent: 'center' } },
                    React.createElement('button', {
                      className: 'history-btn',
                      style: { width: 100 },
                      onClick: async () => {
                        if (isInstalled) {
                          setNotification('App already installed!');
                          setTimeout(() => setNotification(''), 3000);
                          setShowInstallModal(false);
                          return;
                        }
                        if (window.deferredPrompt) {
                          window.deferredPrompt.prompt();
                          // Remove all fallback/cancel messages
                          window.deferredPrompt = null;
                        }
                        setShowInstallModal(false);
                      }
                    }, 'Install'),
                    React.createElement('button', {
                      className: 'history-btn',
                      style: { width: 100, background: '#e53935', color: '#fff' },
                      onClick: () => setShowInstallModal(false)
                    }, 'Cancel')
                  )
                )
              )
            )
          )
        )
      );
    }

    // App wrapper for login state
    function Root() {
      const [user, setUser] = useState(null);
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
          if (u) {
            setUser({
              uid: u.uid,
              name: u.displayName,
              email: u.email,
              photoURL: u.photoURL
            });
          } else {
            setUser(null);
          }
        });
        return () => unsub();
      }, []);
      const handleLogout = () => auth.signOut();
      if (!user) return React.createElement(LoginScreen);
      return React.createElement(AppWithLogout, { onLogout: handleLogout, user });
    }

    // Patch App to use logout
    function AppWithLogout({ onLogout, user }) {
      // Admin detection
      const [isAdmin, setIsAdmin] = React.useState(false);
      React.useEffect(() => {
        if (!user) return setIsAdmin(false);
        if (user.email === 'moghaeashu@gmail.com') return setIsAdmin(true);
        // Check Firestore isAdmin field (REAL-TIME)
        const unsub = db.collection('users').doc(user.uid).onSnapshot(doc => {
          setIsAdmin(!!doc.data()?.isAdmin);
        });
        return () => unsub();
      }, [user]);

      // Admin panel modal state
      const [showAdmin, setShowAdmin] = React.useState(false);
      // Forced graph direction state (from Firestore)
      const [forcedGraph, setForcedGraph] = React.useState({ direction: null, endTime: 0, paused: false });
      // Listen to global forcedGraph in Firestore
      React.useEffect(() => {
        const unsub = db.collection('global').doc('forcedGraph').onSnapshot(doc => {
          if (doc.exists) {
            setForcedGraph(doc.data());
          } else {
            setForcedGraph({ direction: null, endTime: 0, paused: false });
          }
        });
        return () => unsub();
      }, []);
      // Admin panel tab state and data (always alive)
      const [adminTab, setAdminTab] = React.useState('users');
      const [users, setUsers] = React.useState([]);
      const [editingBalanceId, setEditingBalanceId] = React.useState(null);
      const [newBalance, setNewBalance] = React.useState('');
      const [allDeposits, setAllDeposits] = React.useState([]);
      const [allWithdrawals, setAllWithdrawals] = React.useState([]);
      const [userSearch, setUserSearch] = React.useState('');
      // Fetch users when admin panel opens or tab changes (REAL-TIME)
      React.useEffect(() => {
        let unsubs = [];
        if (showAdmin && (adminTab === 'users' || adminTab === 'graph')) {
          const unsub = db.collection('users').onSnapshot(snap => {
            setUsers(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });
          unsubs.push(unsub);
        }
        if (showAdmin && adminTab === 'deposits') {
          // Listen to all users' depositHistory in real-time
          db.collection('users').get().then(snap => {
            const listeners = snap.docs.map(doc =>
              db.collection('users').doc(doc.id).collection('depositHistory')
                .onSnapshot(reqs => {
                  setAllDeposits(prev => {
                    // Remove old for this user, add new
                    const filtered = prev.filter(d => d.userId !== doc.id);
                    const mapped = reqs.docs.map(r => ({ ...r.data(), id: r.id, userId: doc.id, userEmail: doc.data().email }));
                    return [...filtered, ...mapped];
                  });
                })
            );
            unsubs.push(...listeners);
          });
        }
        if (showAdmin && adminTab === 'withdrawals') {
          // Listen to all users' withdrawHistory in real-time
          db.collection('users').get().then(snap => {
            const listeners = snap.docs.map(doc =>
              db.collection('users').doc(doc.id).collection('withdrawHistory')
                .onSnapshot(reqs => {
                  setAllWithdrawals(prev => {
                    // Remove old for this user, add new
                    const filtered = prev.filter(w => w.userId !== doc.id);
                    const mapped = reqs.docs.map(r => ({ ...r.data(), id: r.id, userId: doc.id, userEmail: doc.data().email }));
                    return [...filtered, ...mapped];
                  });
                })
            );
            unsubs.push(...listeners);
          });
        }
        return () => { unsubs.forEach(unsub => unsub && unsub()); };
      }, [showAdmin, adminTab]);

      // Admin actions
      const handleMakeAdmin = (uid) => {
        db.collection('users').doc(uid).update({ isAdmin: true }).then(() => {
          setUsers(users => users.map(u => u.id === uid ? { ...u, isAdmin: true } : u));
        });
      };
      const handleRemoveAdmin = (uid) => {
        db.collection('users').doc(uid).update({ isAdmin: false }).then(() => {
          setUsers(users => users.map(u => u.id === uid ? { ...u, isAdmin: false } : u));
        });
      };
      const handleBlock = (uid) => {
        db.collection('users').doc(uid).update({ blocked: true }).then(() => {
          setUsers(users => users.map(u => u.id === uid ? { ...u, blocked: true } : u));
        });
      };
      const handleUnblock = (uid) => {
        db.collection('users').doc(uid).update({ blocked: false }).then(() => {
          setUsers(users => users.map(u => u.id === uid ? { ...u, blocked: false } : u));
        });
      };
      const handleDeleteUser = (uid) => {
        if (!window.confirm('Are you sure you want to delete this user?')) return;
        // Delete all subcollections first
        Promise.all([
          db.collection('users').doc(uid).collection('tradeHistory').get().then(snap => Promise.all(snap.docs.map(doc => doc.ref.delete()))),
          db.collection('users').doc(uid).collection('depositHistory').get().then(snap => Promise.all(snap.docs.map(doc => doc.ref.delete()))),
          db.collection('users').doc(uid).collection('withdrawHistory').get().then(snap => Promise.all(snap.docs.map(doc => doc.ref.delete())))
        ]).then(() => {
          db.collection('users').doc(uid).delete().then(() => {
            setUsers(users => users.filter(u => u.id !== uid));
          });
        });
      };
      const handleSetBalance = (uid, balance) => {
        db.collection('users').doc(uid).update({ balance: Number(balance) }).then(() => {
          setUsers(users => users.map(u => u.id === uid ? { ...u, balance: Number(balance) } : u));
          setEditingBalanceId(null);
          setNewBalance('');
        });
      };

      // Admin actions for deposits and withdrawals
      const handleApproveDeposit = async (userId, reqId, amount) => {
        try {
          // 1. Get user's current balance
          const userDoc = await db.collection('users').doc(userId).get();
          const currentBalance = userDoc.data()?.balance || 0;
          const newBalance = Number(currentBalance) + Number(amount);

          // 2. Update deposit status and user balance in a batch
          const batch = db.batch();
          batch.update(db.collection('users').doc(userId).collection('depositHistory').doc(reqId), { status: 'success' });
          batch.update(db.collection('users').doc(userId), { balance: newBalance });
          await batch.commit();

          // 3. Update UI
          setAllDeposits(deps => deps.filter(d => !(d.id === reqId && d.userId === userId)));
          setNotification('Deposit approved successfully!');
          setTimeout(() => setNotification(''), 3000);
        } catch (error) {
          console.error('Error approving deposit:', error);
          setNotification('Error approving deposit. Please try again.');
          setTimeout(() => setNotification(''), 3000);
        }
      };

      const handleRejectDeposit = async (userId, reqId) => {
        try {
          await db.collection('users').doc(userId).collection('depositHistory').doc(reqId).update({ status: 'rejected' });
          setAllDeposits(deps => deps.filter(d => !(d.id === reqId && d.userId === userId)));
          setNotification('Deposit rejected.');
          setTimeout(() => setNotification(''), 3000);
        } catch (error) {
          console.error('Error rejecting deposit:', error);
          setNotification('Error rejecting deposit. Please try again.');
          setTimeout(() => setNotification(''), 3000);
        }
      };

      const handleApproveWithdraw = async (userId, reqId) => {
        try {
          await db.collection('users').doc(userId).collection('withdrawHistory').doc(reqId).update({ status: 'success' });
          setAllWithdrawals(wds => wds.filter(w => !(w.id === reqId && w.userId === userId)));
          setNotification('Withdrawal approved successfully!');
          setTimeout(() => setNotification(''), 3000);
        } catch (error) {
          console.error('Error approving withdrawal:', error);
          setNotification('Error approving withdrawal. Please try again.');
          setTimeout(() => setNotification(''), 3000);
        }
      };

      const handleRejectWithdraw = async (userId, reqId, amount) => {
        try {
          // 1. Get user's current balance
          const userDoc = await db.collection('users').doc(userId).get();
          const currentBalance = userDoc.data()?.balance || 0;
          const newBalance = Number(currentBalance) + Number(amount);

          // 2. Update withdrawal status and refund balance in a batch
          const batch = db.batch();
          batch.update(db.collection('users').doc(userId).collection('withdrawHistory').doc(reqId), { status: 'rejected' });
          batch.update(db.collection('users').doc(userId), { balance: newBalance });
          await batch.commit();

          // 3. Update UI
          setAllWithdrawals(wds => wds.filter(w => !(w.id === reqId && w.userId === userId)));
          setNotification('Withdrawal rejected and amount refunded.');
          setTimeout(() => setNotification(''), 3000);
        } catch (error) {
          console.error('Error rejecting withdrawal:', error);
          setNotification('Error rejecting withdrawal. Please try again.');
          setTimeout(() => setNotification(''), 3000);
        }
      };

      // Responsive modal/table styles
      const adminModalStyle = {
        position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.55)', zIndex: 3000, display: 'flex', alignItems: 'center', justifyContent: 'center'
      };
      const adminPanelStyle = {
        background: '#181c23', borderRadius: 18, boxShadow: '0 4px 32px #000a', padding: 18, minWidth: 0, width: '98vw', maxWidth: 600, maxHeight: '90vh', overflowY: 'auto', position: 'relative'
      };
      const adminTableStyle = {
        minWidth: 320, color: '#fff', overflowX: 'auto', fontSize: '1rem', width: '100%'
      };

      // Patch TopBar to use user info
      const PatchedTopBar = () => (
        React.createElement('div', { className: 'top-bar' },
          React.createElement('div', { className: 'profile-left' },
            React.createElement('img', { src: user.photoURL || 'logo.png', className: 'profile-avatar', alt: 'logo' }),
            React.createElement('span', { className: 'profile-username' }, user.name || 'Royal Trader')
          ),
          React.createElement('div', { className: 'profile-actions' },
            isAdmin && React.createElement('button', {
              style: { background: 'none', border: 'none', cursor: 'pointer', marginRight: 10, fontSize: 0 },
              onClick: () => setShowAdmin(true),
              title: 'Admin Panel'
            },
              React.createElement('span', {
                style: {
                  display: 'inline-block', width: 32, height: 32, color: '#FFD600', fontSize: 0
                }
              },
                React.createElement('svg', { width: 28, height: 28, viewBox: '0 0 24 24', fill: 'none', stroke: '#FFD600', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
                  React.createElement('circle', { cx: 12, cy: 12, r: 3 }),
                  React.createElement('path', { d: 'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 9 3.09V3a2 2 0 0 1 4 0v.09c0 .66.39 1.26 1 1.51a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09c0 .66.39 1.26 1 1.51H21a2 2 0 0 1 0 4h-.09c-.66 0-1.26.39-1.51 1z' })
                )
              )
            ),
            React.createElement('button', { className: 'logout-btn', onClick: onLogout }, 'Logout')
          )
        )
      );
      // Render App, but replace TopBar
      return React.createElement(React.Fragment, null,
        React.createElement(PatchedTopBar),
        React.createElement(App, { hideTopBar: true, user, forcedGraph }),
        isAdmin && showAdmin && React.createElement('div', {
          style: adminModalStyle,
          onClick: () => setShowAdmin(false)
        },
          React.createElement('div', {
            style: adminPanelStyle,
            onClick: e => e.stopPropagation()
          },
            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 18 } },
              React.createElement('div', { style: { fontWeight: 700, fontSize: '1.35rem', color: '#FFD600' } }, 'Admin Panel'),
              React.createElement('button', {
                style: { background: 'none', border: 'none', color: '#FFD600', fontSize: '2rem', fontWeight: 700, cursor: 'pointer', lineHeight: 1, padding: 0, marginLeft: 12 },
                onClick: () => setShowAdmin(false)
              }, '×')
            ),
            React.createElement('div', { style: { display: 'flex', gap: 10, marginBottom: 18, flexWrap: 'wrap' } },
              ['users', 'deposits', 'withdrawals', 'clear', 'graph'].map(t =>
                React.createElement('button', {
                  key: t,
                  onClick: () => setAdminTab(t),
                  style: {
                    background: adminTab === t ? '#FFD600' : '#23272f',
                    color: adminTab === t ? '#181c23' : '#FFD600',
                    fontWeight: 700,
                    border: '2px solid #FFD600',
                    borderRadius: 8,
                    padding: '8px 12px',
                    fontSize: '1rem',
                    cursor: 'pointer',
                    transition: 'background 0.2s, color 0.2s',
                    minWidth: 80,
                    flex: '1 1 90px'
                  }
                },
                  t === 'users' ? 'Users' : t === 'deposits' ? 'Deposits' : t === 'withdrawals' ? 'Withdrawals' : t === 'clear' ? 'Clear' : 'Graph'
                )
              )
            ),
            adminTab === 'users' && (
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: 18, alignItems: 'center', width: '100%' } },
                React.createElement('div', { style: { display: 'flex', flexDirection: 'row', alignItems: 'center', gap: 12, width: '100%', marginBottom: 8 } },
                  React.createElement('div', { style: { color: '#FFD600', fontWeight: 700, fontSize: '1.08rem', flex: 1 } }, 'All Users'),
                  React.createElement('input', {
                    type: 'text',
                    placeholder: 'Search by email...',
                    value: userSearch,
                    onChange: e => setUserSearch(e.target.value),
                    style: { padding: '7px 12px', borderRadius: 8, border: '1.5px solid #FFD600', fontSize: '1rem', width: 220, background: '#181c23', color: '#FFD600', fontWeight: 600 }
                  })
                ),
                users.filter(u => !userSearch || (u.email && u.email.toLowerCase().includes(userSearch.toLowerCase()))).map(u => React.createElement('div', {
                  key: u.id,
                  style: {
                    background: '#23272f', borderRadius: 10, marginBottom: 0, padding: 18, boxShadow: '0 2px 8px #0003', maxWidth: 480, minWidth: 220, width: '100%', display: 'flex', flexDirection: 'column', gap: 8
                  }
                },
                  React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 } },
                    React.createElement('span', { style: { color: '#FFD600', fontWeight: 700, fontSize: '1.08rem' } }, u.email || ''),
                    React.createElement('span', { style: { color: '#43a047', fontWeight: 700, fontSize: '1.08rem', marginLeft: 8 } }, typeof u.balance === 'number' ? formatCurrency(u.balance) : ''),
                  ),
                  React.createElement('div', { style: { display: 'flex', gap: 10, flexWrap: 'wrap', marginBottom: 4 } },
                    React.createElement('span', { style: { color: (u.isAdmin || u.email === 'moghaeashu@gmail.com') ? '#43a047' : '#FFD600', fontWeight: 700 } }, (u.isAdmin || u.email === 'moghaeashu@gmail.com') ? 'Admin' : 'User'),
                    React.createElement('span', { style: { color: u.blocked ? '#e53935' : '#43a047', fontWeight: 700 } }, u.blocked ? 'Blocked' : 'Active')
                  ),
                  editingBalanceId === u.id ?
                    React.createElement('form', {
                      style: { display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6 },
                      onSubmit: e => { e.preventDefault(); handleSetBalance(u.id, newBalance); }
                    },
                      React.createElement('input', {
                        type: 'number',
                        value: newBalance,
                        min: 0,
                        style: { width: 90, padding: 4, borderRadius: 4, border: '1px solid #FFD600', fontSize: '1rem' },
                        onChange: e => setNewBalance(e.target.value)
                      }),
                      React.createElement('button', {
                        type: 'submit',
                        style: { background: '#FFD600', color: '#181c23', border: 'none', borderRadius: 4, padding: '4px 14px', fontWeight: 700, cursor: 'pointer', marginLeft: 2 }
                      }, 'Save'),
                      React.createElement('button', {
                        type: 'button',
                        style: { background: '#e53935', color: '#fff', border: 'none', borderRadius: 4, padding: '4px 14px', fontWeight: 700, cursor: 'pointer', marginLeft: 2 },
                        onClick: () => { setEditingBalanceId(null); setNewBalance(''); }
                      }, 'Cancel')
                    ) : null,
                  (u.email !== 'moghaeashu@gmail.com') && React.createElement('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap', marginTop: 4 } },
                    React.createElement('button', {
                      style: { background: '#FFD600', color: '#181c23', border: 'none', borderRadius: 6, padding: '6px 16px', fontWeight: 700, cursor: 'pointer' },
                      onClick: () => { setEditingBalanceId(u.id); setNewBalance(u.balance !== undefined ? u.balance : ''); },
                    }, 'Set Balance'),
                    React.createElement('button', {
                      style: { background: u.isAdmin ? '#e53935' : '#43a047', color: '#fff', border: 'none', borderRadius: 6, padding: '6px 16px', fontWeight: 700, cursor: 'pointer' },
                      onClick: () => u.isAdmin ? handleRemoveAdmin(u.id) : handleMakeAdmin(u.id)
                    }, u.isAdmin ? 'Remove Admin' : 'Make Admin'),
                    React.createElement('button', {
                      style: { background: u.blocked ? '#43a047' : '#e53935', color: '#fff', border: 'none', borderRadius: 6, padding: '6px 16px', fontWeight: 700, cursor: 'pointer' },
                      onClick: () => u.blocked ? handleUnblock(u.id) : handleBlock(u.id)
                    }, u.blocked ? 'Unblock' : 'Block'),
                    React.createElement('button', {
                      style: { background: '#FFD600', color: '#181c23', border: 'none', borderRadius: 6, padding: '6px 16px', fontWeight: 700, cursor: 'pointer' },
                      onClick: () => handleDeleteUser(u.id)
                    }, 'Delete')
                  )
                ))
              )
            ),
            adminTab === 'deposits' && (
              React.createElement('div', { style: { overflowX: 'auto' } },
                React.createElement('div', { style: { color: '#FFD600', fontWeight: 700, fontSize: '1.08rem', marginBottom: 8 } }, 'Deposit Requests'),
                allDeposits.filter(d => d.status === 'pending').length === 0 ? (
                  React.createElement('div', { style: { color: '#fff', fontWeight: 600, margin: 18 } }, 'No pending deposit requests.')
                ) : (
                  allDeposits.filter(d => d.status === 'pending').map((d, i) =>
                    React.createElement('div', {
                      key: d.id + d.userId,
                      style: { background: '#23272f', borderRadius: 10, marginBottom: 18, padding: 16, boxShadow: '0 2px 8px #0003', maxWidth: 480, minWidth: 220 }
                    },
                      React.createElement('div', { style: { marginBottom: 8 } },
                        React.createElement('span', { style: { color: '#FFD600', fontWeight: 700 } }, d.userEmail || ''),
                        ' | ',
                        d.time ? new Date(d.time).toLocaleTimeString() : ''
                      ),
                      React.createElement('div', null, 'UPI: ', React.createElement('span', { style: { color: '#FFD600' } }, d.upi)),
                      React.createElement('div', null, 'Amount: ', React.createElement('span', { style: { color: '#4caf50', fontWeight: 600 } }, formatCurrency(d.amount))),
                      React.createElement('div', null, 'Status: ', React.createElement('span', null, d.status ? d.status.charAt(0).toUpperCase() + d.status.slice(1) : 'Pending')),
                      React.createElement('div', { style: { marginTop: 12, display: 'flex', gap: 10, justifyContent: 'flex-end' } },
                        React.createElement('button', {
                          style: { background: '#43a047', color: '#fff', border: 'none', borderRadius: 6, padding: '6px 18px', fontWeight: 700, cursor: 'pointer' },
                          onClick: () => handleApproveDeposit(d.userId, d.id, d.amount)
                        }, 'Approve'),
                        React.createElement('button', {
                          style: { background: '#e53935', color: '#fff', border: 'none', borderRadius: 6, padding: '6px 18px', fontWeight: 700, cursor: 'pointer' },
                          onClick: () => handleRejectDeposit(d.userId, d.id)
                        }, 'Reject')
                      )
                    )
                  )
                )
              )
            ),
            adminTab === 'withdrawals' && (
              React.createElement('div', { style: { overflowX: 'auto' } },
                React.createElement('div', { style: { color: '#FFD600', fontWeight: 700, fontSize: '1.08rem', marginBottom: 8 } }, 'Withdrawal Requests'),
                allWithdrawals.filter(w => w.status === 'pending').length === 0 ? (
                  React.createElement('div', { style: { color: '#fff', fontWeight: 600, margin: 18 } }, 'No pending withdrawal requests.')
                ) : (
                  allWithdrawals.filter(w => w.status === 'pending').map((w, i) =>
                    React.createElement('div', {
                      key: w.id + w.userId,
                      style: { background: '#23272f', borderRadius: 10, marginBottom: 18, padding: 16, boxShadow: '0 2px 8px #0003', maxWidth: 480, minWidth: 220 }
                    },
                      React.createElement('div', { style: { marginBottom: 8 } },
                        React.createElement('span', { style: { color: '#FFD600', fontWeight: 700 } }, w.userEmail || ''),
                        ' | ',
                        w.time ? new Date(w.time).toLocaleTimeString() : ''
                      ),
                      React.createElement('div', null, 'UPI: ', React.createElement('span', { style: { color: '#FFD600' } }, w.upi)),
                      React.createElement('div', null, 'Amount: ', React.createElement('span', { style: { color: '#4caf50', fontWeight: 600 } }, formatCurrency(w.amount))),
                      React.createElement('div', null, 'Status: ', React.createElement('span', null, w.status ? w.status.charAt(0).toUpperCase() + w.status.slice(1) : 'Pending')),
                      React.createElement('div', { style: { marginTop: 12, display: 'flex', gap: 10, justifyContent: 'flex-end' } },
                        React.createElement('button', {
                          style: { background: '#43a047', color: '#fff', border: 'none', borderRadius: 6, padding: '6px 18px', fontWeight: 700, cursor: 'pointer' },
                          onClick: () => handleApproveWithdraw(w.userId, w.id)
                        }, 'Approve'),
                        React.createElement('button', {
                          style: { background: '#e53935', color: '#fff', border: 'none', borderRadius: 6, padding: '6px 18px', fontWeight: 700, cursor: 'pointer' },
                          onClick: () => handleRejectWithdraw(w.userId, w.id, w.amount)
                        }, 'Reject')
                      )
                    )
                  )
                )
              )
            ),
            adminTab === 'clear' && (
              React.createElement('div', { style: { padding: 24, textAlign: 'center' } },
                React.createElement('div', { style: { color: '#FFD600', fontWeight: 700, fontSize: '1.15rem', marginBottom: 18 } }, 'Clear All Data'),
                React.createElement('div', { style: { color: '#fff', marginBottom: 18, fontWeight: 600 } },
                  'This will delete all trade, deposit, and withdrawal history for all users. User accounts and balances will be kept. This action cannot be undone!'
                ),
                React.createElement('button', {
                  style: { background: '#e53935', color: '#fff', border: 'none', borderRadius: 8, padding: '14px 38px', fontWeight: 700, fontSize: '1.1rem', cursor: 'pointer', marginTop: 10 },
                  onClick: async () => {
                    if (!window.confirm('Are you sure you want to delete ALL trade, deposit, and withdrawal history for ALL users? This cannot be undone!')) return;
                    try {
                      const usersSnap = await db.collection('users').get();
                      for (const userDoc of usersSnap.docs) {
                        const uid = userDoc.id;
                        for (const sub of ['tradeHistory', 'depositHistory', 'withdrawHistory']) {
                          const subSnap = await db.collection('users').doc(uid).collection(sub).get();
                          for (const doc of subSnap.docs) {
                            await doc.ref.delete();
                          }
                        }
                      }
                      setNotification('All history data cleared!');
                      setTimeout(() => setNotification(''), 4000);
                    } catch (err) {
                      setNotification('Error clearing data. Try again.');
                      setTimeout(() => setNotification(''), 4000);
                    }
                  }
                }, 'Clear All')
              )
            ),
            adminTab === 'graph' && (
              React.createElement('div', { style: { padding: 24, textAlign: 'center', maxWidth: 400, margin: '0 auto' } },
                React.createElement('div', { style: { color: '#FFD600', fontWeight: 700, fontSize: '1.15rem', marginBottom: 18 } }, 'Force Graph Direction'),
                React.createElement('form', {
                  onSubmit: async e => {
                    e.preventDefault();
                    const duration = Number(e.target.duration.value);
                    const direction = e.target.direction.value;
                    if (!duration || !direction) return;
                    const endTime = Date.now() + duration * 1000;
                    await db.collection('global').doc('forcedGraph').set({ direction, endTime }, { merge: true });
                  },
                  style: { display: 'flex', flexDirection: 'column', gap: 14, alignItems: 'center' }
                },
                  React.createElement('input', {
                    type: 'number',
                    name: 'duration',
                    min: 1,
                    placeholder: 'Duration (seconds)',
                    style: { padding: '8px 14px', borderRadius: 8, border: '1.5px solid #FFD600', fontSize: '1rem', width: 180, background: '#181c23', color: '#FFD600', fontWeight: 600 }
                  }),
                  React.createElement('select', {
                    name: 'direction',
                    style: { padding: '8px 14px', borderRadius: 8, border: '1.5px solid #FFD600', fontSize: '1rem', width: 180, background: '#181c23', color: '#FFD600', fontWeight: 600 }
                  },
                    React.createElement('option', { value: '' }, 'Select Direction'),
                    React.createElement('option', { value: 'up' }, 'Up'),
                    React.createElement('option', { value: 'down' }, 'Down')
                  ),
                  React.createElement('button', {
                    type: 'submit',
                    style: { background: '#FFD600', color: '#181c23', border: 'none', borderRadius: 8, padding: '10px 28px', fontWeight: 700, fontSize: '1.08rem', cursor: 'pointer', marginTop: 10 }
                  }, 'Force Direction')
                ),
                // Move up/down bet totals box here
                React.createElement(AdminGraphBets, { users }),
                // Start/Stop Graph Controls
                React.createElement('div', { style: { marginTop: 24, display: 'flex', gap: 16, justifyContent: 'center' } },
                  React.createElement('button', {
                    style: { background: forcedGraph.paused ? '#43a047' : '#FFD600', color: '#181c23', border: 'none', borderRadius: 8, padding: '10px 28px', fontWeight: 700, fontSize: '1.08rem', cursor: forcedGraph.paused ? 'pointer' : 'not-allowed', opacity: forcedGraph.paused ? 1 : 0.7 },
                    disabled: !forcedGraph.paused,
                    onClick: async () => {
                      await db.collection('global').doc('forcedGraph').set({ paused: false }, { merge: true });
                    }
                  }, 'Start Graph'),
                  React.createElement('button', {
                    style: { background: forcedGraph.paused ? '#FFD600' : '#e53935', color: '#181c23', border: 'none', borderRadius: 8, padding: '10px 28px', fontWeight: 700, fontSize: '1.08rem', cursor: forcedGraph.paused ? 'not-allowed' : 'pointer', opacity: forcedGraph.paused ? 0.7 : 1 },
                    disabled: !!forcedGraph.paused,
                    onClick: async () => {
                      await db.collection('global').doc('forcedGraph').set({ paused: true }, { merge: true });
                    }
                  }, 'Stop Graph')
                ),
                forcedGraph.direction && forcedGraph.endTime > Date.now() && (
                  React.createElement('div', { style: { color: '#4caf50', fontWeight: 600, marginTop: 18 } },
                    `Graph is being forced ${forcedGraph.direction.toUpperCase()} for ${Math.ceil((forcedGraph.endTime - Date.now()) / 1000)}s`
                  )
                ),
                forcedGraph.paused && (
                  React.createElement('div', { style: { color: '#e53935', fontWeight: 700, marginTop: 12 } }, 'Graph is currently STOPPED for all users.')
                )
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(Root));

    // PWA install prompt handler
    window.deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      window.deferredPrompt = e;
    });

    // Add service worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js');
      });
    }

    // Add isInstalled state and effect
    React.useEffect(() => {
      const checkInstalled = () => {
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
          setIsInstalled(true);
        } else {
          setIsInstalled(false);
        }
      };
      checkInstalled();
      window.addEventListener('appinstalled', checkInstalled);
      window.addEventListener('DOMContentLoaded', checkInstalled);
      return () => {
        window.removeEventListener('appinstalled', checkInstalled);
        window.removeEventListener('DOMContentLoaded', checkInstalled);
      };
    }, []);

    // Attractive notification messages
    const notificationMessages = [
      "Trade now and win big prizes!",
      "Your luck is waiting. Place a trade!",
      "Royal Trader: Make your next move!",
      "Markets are moving. Are you?",
      "Double your deposit today!",
      "Feeling lucky? Try a quick trade!",
      "Your wallet misses you. Trade now!",
      "Big rewards await. Start trading!",
      "Don't miss out on today's trends!",
      "Royal Trader: Your profit journey starts now!",
      "Get in the game! Place your next trade.",
      "Opportunities are knocking. Open Royal Trader!"
    ];
    // Ask for notification permission on app load
    useEffect(() => {
      if (window.Notification && Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
    }, []);
    // Send notification every 3 minutes if installed
    useEffect(() => {
      if (!isInstalled || !('serviceWorker' in navigator)) return;
      let interval = setInterval(() => {
        if (Notification.permission === 'granted') {
          const msg = notificationMessages[Math.floor(Math.random() * notificationMessages.length)];
          navigator.serviceWorker.getRegistration().then(reg => {
            if (reg) {
              reg.showNotification('Royal Trader', {
                body: msg,
                icon: 'logo.png',
                badge: 'logo.png',
                data: { url: 'https://chipper-syrniki-d20dcc.netlify.app/' }
              });
            }
          });
        }
      }, 180000); // 3 minutes
      return () => clearInterval(interval);
    }, [isInstalled]);
    // Ask for notification permission and show notification on app load
    useEffect(() => {
      if (window.Notification) {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted' && 'serviceWorker' in navigator && isInstalled) {
            const msg = notificationMessages[Math.floor(Math.random() * notificationMessages.length)];
            navigator.serviceWorker.getRegistration().then(reg => {
              if (reg) {
                reg.showNotification('Royal Trader', {
                  body: msg,
                  icon: 'logo.png',
                  badge: 'logo.png',
                  data: { url: 'https://chipper-syrniki-d20dcc.netlify.app/' }
                });
              }
            });
          }
        });
      }
    }, [isInstalled]);

    // Add iOS detection helper
    function isIOS() {
      return /iphone|ipad|ipod/i.test(navigator.userAgent);
    }

    // Add this component above adminTab === 'graph' in AppWithLogout or as a helper in the same file
    function AdminGraphBets({ users }) {
      // Sum up openTrade amounts for up and down
      let up = 0, down = 0;
      const now = Date.now();
      users.forEach(u => {
        if (u.openTrade && u.openTrade.entryTime && u.openTrade.resolveTime && u.openTrade.resolveTime > now) {
          if (u.openTrade.direction === 'up') up += Number(u.openTrade.amount) || 0;
          if (u.openTrade.direction === 'down') down += Number(u.openTrade.amount) || 0;
        }
      });
      return React.createElement('div', {
        style: {
          marginBottom: 18,
          fontWeight: 700,
          fontSize: '1.08rem',
          color: '#FFD600',
          display: 'flex',
          justifyContent: 'center',
          gap: 24,
          background: '#23272f',
          borderRadius: 10,
          padding: '10px 0',
          border: '2px solid #FFD600',
          maxWidth: 340,
          marginLeft: 'auto',
          marginRight: 'auto',
          marginTop: 10,
        }
      },
        React.createElement('span', null, `UP: ₹${up.toLocaleString('en-IN')}`),
        React.createElement('span', null, `DOWN: ₹${down.toLocaleString('en-IN')}`)
      );
    }

    // App function ke andar, useEffect add karo:
    useEffect(() => {
      if (!user) return;
      const today = new Date().toLocaleDateString('en-GB');
      const lastCleared = localStorage.getItem('lastClearedDate');
      if (lastCleared !== today) {
        // Purge trade history for this user
        db.collection('users').doc(user.uid).collection('tradeHistory').get().then(snap => {
          snap.docs.forEach(doc => doc.ref.delete());
          localStorage.setItem('lastClearedDate', today);
        });
      }
    }, [user]);

    // Listen to deposit history and enforce deposit requirement
    useEffect(() => {
      if (!user) return;
      const unsub = db.collection('users').doc(user.uid).collection('depositHistory')
        .onSnapshot(snap => {
          const deposits = snap.docs.map(doc => doc.data());
          setDepositHistory(deposits);
          // Check if any deposit is successful
          const hasDeposit = deposits.some(d => d.status && d.status.toLowerCase() === 'success');
          setMustDeposit(!hasDeposit);
          // If no deposit, show deposit modal
          if (!hasDeposit) setShowDeposit(true);
        });
      return () => unsub();
    }, [user]);
  </script>
</body>
</html> 
